pipeline {
    agent { label 'AnsibleControlNode' }

    tools {
        maven 'Maven'
    }

    stages {
        stage('Maven Build') {
            steps {
                echo 'Triggering Maven build...'
                script {
                    // Specify the full path to Maven binary
                    sh "/opt/apache-maven-3.9.6/bin/mvn clean package"
                }
            }
        }

        stage('Docker Build') {
            steps {
                echo 'Building Docker image...'
                script {
                    // Specify the Docker daemon's TCP port
                    def dockerHost = 'tcp://192.168.4.114:2375'

                    // Build Docker image
                    sh "docker -H=$dockerHost build -t domdoxe/project ."

                    // Log in to Docker Hub (replace 'username', 'password', and 'domdoxe/project' with your Docker Hub credentials and image name)
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                        sh "docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD"
                    }
                }
            }
        }

        stage('DockerHub Push') {
            steps {
                echo 'Pushing Docker image to DockerHub...'
                script {
                    // Specify the Docker daemon's TCP port
                    def dockerHost = 'tcp://192.168.4.114:2375'

                    // Push Docker image to DockerHub
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                        sh "docker -H=$dockerHost push domdoxe/project"
                    }
                }
            }
        }

        stage('Docker Deploy') {
            agent {
                label 'AnsibleControlNode'
            }
            steps {
                echo 'Deploying Docker container using Ansible...'
                script {
                    // Specify the Docker daemon's TCP port
                    def dockerHost = 'tcp://192.168.4.114:2375'

                    // Run Ansible playbook to deploy Docker container
                    ansiblePlaybook credentialsId: 'docker-hub-credentials', installation: 'ansible', inventory: '/etc/ansible/hosts', playbook: 'deploy-docker.yml', extras: "-e docker_host=${dockerHost}"
                }
            }
        }
    }
}

